<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Meat4Eat - WS Connection Test</title>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="public/libs/js/jquery.js"></script>
		<script src="public/libs/js/bootstrap.js"></script>
		<script src="public/libs/js/Meet4Eat-REST.js"></script>
		<script src="public/libs/js/Meet4Eat-COMM.js"></script>
		<link rel="stylesheet" href="public/libs/css/bootstrap.css" type="text/css">
		<link rel="stylesheet" href="public/libs/css/font-awesome.css" type="text/css">
		<link rel="stylesheet" href="public/libs/css/Meet4Eat-UI.css" type="text/css">
	</head>
	<body>
		<div class="container">
			<h1 class="text-center">Meet4Eat - WS Connection Test</h1>
			<div class="row">
				<div class="col-sm-8 col-sm-offset-2">
					<div class="panel panel-default">
						<div class="panel-heading">
							<strong>Communication log</strong>
						</div>
						<!-- /.panel-heading -->
						<div class="panel-body">
							<div id="output"></div>
						</div>
					</div>
					<a class="btn btn-lg btn-primary col-lg-5 pull-right" onclick="notifyUsers()">Notify Users</a>
				</div>
			</div>
		</div>
		<script>

			function requestJSON(requestUrl, requestData, method, responseCallback) {
				var json = requestData ? JSON.stringify(requestData) : null;
				$.ajax({
					type: method,
					url: requestUrl,
					data: json,
					contentType: "application/json; charset=UTF-8",
					dataType: "text",
					cache: false,
					success: function(response) {
						if (responseCallback !== null) {
							var results = null;
							try {
								results = $.parseJSON(response);
								// the data is also expected to be in JSON format
								if (results.data) {
									results.data = $.parseJSON(results.data);
								}
							}
							catch(e) {
								if (responseCallback.error) {
									responseCallback.error("Exception occurred while parsing JSON response, reason: " + e, response);
								}
							}
							if (responseCallback.success) {
								responseCallback.success(results, response);
							}
						}
					},
					error: function(jqXHR, errorString, errorThrown ) {
						if (responseCallback && responseCallback.error) {
							responseCallback.error("Problem while contacting '" + requestUrl + "' | Error string: " + errorString + " | Error thrown: " + errorThrown, jqXHR);
						}
					}
				});
			};

			function notifyUsers() {
				// NOTE make sure that an event with following ID exists on server
				var eventid = 456;
				var url = "/m4e-webapp/webresources/rest/events/notifyMembers/" + eventid;
				var notify = { 'subject': 'Buzz', 'text' : 'Coffee in the kitchen' };
				requestJSON(url, notify, 'POST', {
					success(results, response) {
						if (results.status === "ok") {
							outputText("Event members were successfully notified.");
						}
						else {
							outputText("Problem occurred while notifiying event members: " + results.description);
						}
					},
					error(text, resp) {
						alert("Problem notifying event members! Reson: " + text + "\n" + resp);
					}
				});
			}

			function outputText(text) {
				var txt = $('#output').html();
				$('#output').html(txt + "<br>" + text);
			}

			function testWS() {

				outputText('Trying to connect the server...');

				var comm = new Meet4EatCOMM();
				comm.connect( {
					onOpen: function() {
						outputText('Connection was established');
						var packet = { "subject" : "Ping", "text" : "Hello Server" };
						comm.send(0, 'notify', packet);
					},
					onError: function(error) {
						outputText('WebSocket Error: ' + error);
					},
					onMessage: function(msg) {
						outputText('Message arrived: ' + JSON.stringify(msg.data));
					},
					onClose: function(response) {
						outputText('Connection was closed, code ' + response.code + ", reason: " + response.reason);
					}
				});
			}

			/* initialize UI */
			$(function() {
				testWS();
			});
		</script>
	</body>
</html>
